@page "/Grid/FoodAlerts"
@layout SampleLayout
@using DbNetSuiteCore.Blazor.Samples.Components.Layout
@using DbNetSuiteCore.Blazor.Samples.Components.Pages
@using DbNetSuiteCore.Models
@using DbNetSuiteCore.Constants
@using DbNetSuiteCore.Enums
@using DbNetSuiteCore.Samples.Plugins
@using Microsoft.AspNetCore.Components.Sections
@inject IHttpContextAccessor httpContextAccessor

<PageTitle>Food Alerts</PageTitle>

<div style="display:flex;flex-direction:row;gap:10px;align-items:center;padding-bottom:10px">
    <div><strong>Alert Type</strong></div>
    <div>
        <select id="alertType" data-param="type">
            <option value="">All</option>
            <option value="AA">Allergy Alert</option>
            <option value="PRIN">Product Recall Information Notice</option>
            <option value="FAFA">Food Alert For Action</option>
        </select>
    </div>
    <div><strong>Period</strong></div>
    <div>
        <select id="period" data-param="since">
            @{
                for (int days = 120; days >= 30; days -= 30)
                {
                    <option value="@DateTime.Now.AddDays(0 - days).ToString("yyyy-MM-ddTHH:mm:ssZ")" selected="@(days == 60 ? "true" : "false")">Last @days days</option>
                }
            }
            </select>
        </div>
</div>

@{
    var gridModel = new GridModel(DataSourceType.JSON, "https://data.food.gov.uk/food-alerts/id")
    {
        Caption = "Food Alerts",
        JsonTransformPlugin = typeof(FoodAlertsTransform)
    };

    gridModel.Columns = new List<GridColumn>()
    {
        new GridColumn("Title"),
        new GridColumn("Notation"),
        new GridColumn("Created"),
        new GridColumn("Modified"),
        new GridColumn("Type") { Format = FormatType.Url},
        new GridColumn("ShortTitle"),
        new GridColumn("Status"),
        new GridColumn("AlertURL") { Format = FormatType.Url},
        new GridColumn("ReportingBusiness") {Filter = FilterType.Distinct},
        new GridColumn("Problem"),
        new GridColumn("ProductDetails"),
        new GridColumn("Country"),
    };
    gridModel.ApiRequestParameters["_limit"] = "100";
    gridModel.ApiRequestParameters["since"] = DateTime.Now.AddDays(-60).ToString("yyyy-MM-ddTHH:mm:ssZ");
    gridModel.ApiRequestParameters["type"] = "";

    gridModel.ClientEvents[GridClientEvent.Initialised] = "saveGridRef";
    @DbNetSuiteCore.Blazor.Control.Create(httpContextAccessor).Render(gridModel);
}

<SectionContent SectionName="summary">
    <p data-summary>This sample demonstrates use of the JsonTransformPlugin property to convert the results of an API call into a more desirable format. The property is assigned the type of a class that implements the IJsonTransformPlugin interface. The raw API JSON will be deserialized usnig this class and then transformed into an IEnumerable that will then used as the grid data source</p>
</SectionContent>

<script>
    function updateParam(event)
    {       
        var params = {}
        params[event.target.dataset.param] = event.target.value;
        window.foodAlertsGrid.updateApiRequestParameters(params);
    }

    function saveGridRef(sender, args)
    {
        document.querySelector("#alertType").addEventListener("change", updateParam);
        document.querySelector("#period").addEventListener("change", updateParam);

        window.foodAlertsGrid = sender;
    }
</script>

